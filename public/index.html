<html>
    <head>
        <title>MasterRoulette</title>
        <link rel="stylesheet" href="main.css" type="text/css" />
        <script src="js/Winwheel.min.js"></script>
        <script src="js/sweetalert.min.js"></script>
        <script src="js/TweenMax.min.js"></script>
        <link href="css/label.css" rel="stylesheet" />
        <link href="css/sweetalert.css" rel="stylesheet" />
        <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.4.1/css/bootstrap.min.css" integrity="sha384-Vkoo8x4CGsO3+Hhxv8T/Q5PaXtkKtu6ug5TOeNV6gBiFeWPGFN9MuhOf23Q9Ifjh" crossorigin="anonymous">
        <script src="https://code.jquery.com/jquery-3.4.1.slim.min.js" integrity="sha384-J6qa4849blE2+poT4WnyKhv5vZF5SrPo0iEjwBvKU7imGFAV0wwj1yYfoRSJoZ+n" crossorigin="anonymous"></script>
        <script src="https://cdn.jsdelivr.net/npm/popper.js@1.16.0/dist/umd/popper.min.js" integrity="sha384-Q6E9RHvbIyZFJoft+2mJbHaEWldlvI9IOYy5n3zV9zzTtmI3UksdQRVvoxMfooAo" crossorigin="anonymous"></script>
        <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.4.1/js/bootstrap.min.js" integrity="sha384-wfSDF2E50Y2D1uUdj0O3uMBJnjuUD4Ih7YwaYd1iqfktj0Uod8GCExl3Og8ifwB6" crossorigin="anonymous"></script>
        <script src="http://cdnjs.cloudflare.com/ajax/libs/gsap/latest/TweenMax.min.js"></script>
    </head>
    <body>

        <!-- MENSAJE QUE VA ARRIBA DELA RULETA JUNTO CON EL MODAl -->
        <div align="center" >
            <h1 id="sala" class="label" >Aqui estara tu sala</h1>
            <img id ="imgsala"> </img>
            <div id="myModal" class="modal show" tabindex="-1" role="dialog">
                <div class="modal-dialog modal-xl " >
                    <div class="modal-content">

                        <div class="modal-body">
                            <img src="img/Viejas.png">
                            <p>
                                
                                <h3>
                                Bienvenido al casino de Presi y Rivera !
                                Al seleccionar una sala, usted acepta que es mayor de +18 años.
                                </h3>
                            </p>
                        </div>
                                                    
                            <h2 for="recipient-name" class="col-1-label" >Usuario:</h2>
                            <input type="text" class="form-control" id="Name">
                            <div class="btn-group" role="group" aria-label="Basic example"> 
  
                                <button type="submit" class="btn btn-primary" data-dismiss="modal" onclick="connectRoom('Diamante')">Diamante</button>
                                <button type="submit" class="btn btn-success" data-dismiss="modal"onclick="connectRoom('Trebol')">Trebol</button>
                                <button type="submit" class="btn btn-danger"data-dismiss="modal"onclick="connectRoom('Corazon')">Corazon</button>
                                <button type="submit" class="btn btn-dark"data-dismiss="modal" onclick="connectRoom('Pica')">Picas</button>
                            </div>
                </div>
                </div>
            </div>
        </div>


        <div class="container">
            <div class="row">
              <div class="col order-last">

                <div id="Apostadores">
                    <table id="p1"></table>
                </div>
                <ul id="messages"></ul>

              </div>
              <div class="col">
                  <div class="the_wheel">
                    <canvas id="canvas" width="715" height="951">
                        <p style="{color: black}" align="center">Sorry, your browser doesn't support canvas. Please try another.</p>
                    </canvas>
                </div>  
              </div>
              <div class="col order-first">
                  

        
                    <table class="power" cellpadding="10" cellspacing="0">
                        <tr>
                            <th align="center">Velocidades</th>
                        </tr>
                        <tr>
                            <td width="78" align="center" id="pw3" onClick="powerSelected(3);">Alta</td>
                        </tr>
                        <tr>
                            <td align="center" id="pw2" onClick="powerSelected(2);">Media</td>
                        </tr>
                        <tr>
                            <td align="center" id="pw1" onClick="powerSelected(1);">Baja</td>
                        </tr>
                    </table>
                    <br/>
                    <img id="spin_button" src="spin_off.png" alt="Spin" onClick="mySpin();" />
                    <br /><br />
                </div>

              </div>
            </div>
        </div>

            <div class="container">
                <div class="row">
                
                    <table class="table table-bordered table-dark">

                    <tbody>

                        <tr>
                        <td rowspan="4"><button type="button" name="botonApuesta"class="btn btn-success"onclick="apostar(0)"><br><br><br>0<br><br><br><br></button></td>
                        <td><button type="button" name="botonApuesta" class="btn btn-danger" onclick="apostar(3)">3</button></td>
                        <td><button type="button" name="botonApuesta" class="btn btn-secondary"onclick="apostar(6)">6</button></td>
                        <td><button type="button" name="botonApuesta" class="btn btn-danger"onclick="apostar(9)">9</button></td>
                        <td><button type="button" name="botonApuesta" class="btn btn-danger" onclick="apostar(12)">12</button></td>
                        <td><button type="button" name="botonApuesta" class="btn btn-secondary" onclick="apostar(15)">15</button></td>
                        <td><button type="button" name="botonApuesta" class="btn btn-danger" onclick="apostar(18)">18</button></td>
                        <td><button type="button" name="botonApuesta" class="btn btn-danger" onclick="apostar(21)">21</button></td>
                        <td><button type="button" name="botonApuesta" class="btn btn-secondary" onclick="apostar(24)">24</button></td>
                        <td><button type="button" name="botonApuesta" class="btn btn-danger" onclick="apostar(27)">27</button></td>
                        <td><button type="button" name="botonApuesta" class="btn btn-danger" onclick="apostar(30)">30</button></td>
                        <td><button type="button" name="botonApuesta" class="btn btn-secondary" onclick="apostar(33)">33</button></td>
                        <td><button type="button" name="botonApuesta" class="btn btn-danger" onclick="apostar(36)">36</button></td>
                        <td><button type="button" name="botonApuesta" class="btn btn-warning"onclick="apostar(37)">Fila</button></td>
                        <td rowspan="5" colspan="2"><button type="button" id="apuestaReady" class="btn btn-success"onclick="apuestasReady()" disabled= true><br><br><br>Apuestas ready!<br><br><br><br></button></td>

                    
                        </tr>

                        <tr>
                            <td><button type="button" name="botonApuesta" class="btn btn-secondary"onclick="apostar(2)">2</button></td>
                            <td><button type="button" name="botonApuesta" class="btn btn-danger"onclick="apostar(5)">5</button></td>
                            <td><button type="button" name="botonApuesta" class="btn btn-secondary"onclick="apostar(8)">8</button></td>
                            <td><button type="button" name="botonApuesta" class="btn btn-secondary"onclick="apostar(11)">11</button></td>
                            <td><button type="button" name="botonApuesta" class="btn btn-danger"onclick="apostar(14)">14</button></td>
                            <td><button type="button" name="botonApuesta" class="btn btn-secondary"onclick="apostar(17)">17</button></td>
                            <td><button type="button" name="botonApuesta" class="btn btn-secondary"onclick="apostar(20)">20</button></td>
                            <td><button type="button" name="botonApuesta" class="btn btn-danger"onclick="apostar(23)">23</button></td>
                            <td><button type="button" name="botonApuesta" class="btn btn-secondary"onclick="apostar(26)">26</button></td>
                            <td><button type="button" name="botonApuesta" class="btn btn-secondary"onclick="apostar(29)">29</button></td>
                            <td><button type="button" name="botonApuesta" class="btn btn-danger"onclick="apostar(32)">32</button></td>
                            <td><button type="button" name="botonApuesta" class="btn btn-secondary"onclick="apostar(35)">35</button></td>
                            <td><button type="button" name="botonApuesta" class="btn btn-warning"onclick="apostar(38)">Fila</button></td>
                        </tr>
                        <tr>

                            <td><button type="button" name="botonApuesta" class="btn btn-danger"onclick="apostar(1)">1</button></td>
                            <td><button type="button" name="botonApuesta" class="btn btn-secondary"onclick="apostar(4)">4</button></td>
                            <td><button type="button" name="botonApuesta" class="btn btn-danger"onclick="apostar(7)">7</button></td>
                            <td><button type="button" name="botonApuesta" class="btn btn-secondary"onclick="apostar(10)">10</button></td>
                            <td><button type="button" name="botonApuesta" class="btn btn-secondary"onclick="apostar(13)">13</button></td>
                            <td><button type="button" name="botonApuesta" class="btn btn-danger" onclick="apostar(16)">16</button></td>
                            <td><button type="button" name="botonApuesta" class="btn btn-danger"onclick="apostar(19)">19</button></td>
                            <td><button type="button" name="botonApuesta" class="btn btn-secondary"onclick="apostar(22)">22</button></td>
                            <td><button type="button" name="botonApuesta" class="btn btn-danger"onclick="apostar(25)">25</button></td>
                            <td><button type="button" name="botonApuesta" class="btn btn-secondary"onclick="apostar(28)">28</button></td>
                            <td><button type="button" name="botonApuesta" class="btn btn-secondary"onclick="apostar(31)">31</button></td>
                            <td><button type="button" name="botonApuesta" class="btn btn-danger"onclick="apostar(34)">34</button></td>
                            <td><button type="button" name="botonApuesta" class="btn btn-warning"onclick="apostar(39)">Fila</button></td>
                        </tr>
                        <tr>
                            <td colspan="6"  style="text-align:center"><button name="botonApuesta" type="button" class="btn btn-secondary btn-lg"onclick="apostar(41)">NEGROOO</button></td>
                            <td colspan="6"  style="text-align:center"><button name="botonApuesta" type="button"  class="btn btn-danger btn-lg"onclick="apostar(40)">ROJOOO</button></td>

                        </tr>
                    
                    </tbody>
                    </table>
                
                </div>
            </div>
        <script src="/socket.io/socket.io.js"></script>

        <script>

            $( document ).ready(function() {
                $('#myModal').modal('toggle')
            });


            var buttonsApuesta=document.getElementsByName("botonApuesta");
            var credito=10000;
            var usuario;
            const socket = io.connect();
            var myTurn=false;
            var timeApuesta=true;

            socket.on('newUser',llenarTabla);
            socket.on('rotateGuest',otherSpin);
            socket.on('userLeft',llenarTabla);
            socket.on('checkApuesta',llenarTabla);
            socket.on('newRound',ganoApuesta)
            socket.on('host',()=>{myTurn=true
                console.log('Te toca girar',myTurn);
                SelectHost();
            })
            socket.on('text',(data)=>{
                console.log(data);  
                $('#messages').append($('<li>').text(data));

            })

            socket.on('estasSolo',data=>alert(data));
            
            function apuestasReady(){
                cambiarBotones();
                timeApuesta=false;
                socket.emit('apuestaReady')
                document.getElementById("apuestaReady").disabled=true;
                
            }

            function cambiarBotones(){ 
                if(timeApuesta==true)for(let i of buttonsApuesta)i.disabled=true;      
                else  for(let i of buttonsApuesta)i.disabled=false
                console.log('cambiando botones');

            }

            function ganoApuesta(data){
                console.log('data',data);
                resetWheel();
                let found = data.arreglo.find(element => element.socket==socket.id);
                if(found.credito>credito){
                    swal({
                        title: " !!! El numero ganador fue :  " + "   "+ data.numberWin + " y usted ganó!!! " +(found.credito - credito)+ "",
                        imageUrl: "img/Muerte.png",
                        showAcceptButton: true,
                        confirmButtonColor: "#e74c3c",
                        confirmButtonText: "Okey",
                        closeOnConfirm: true
                    })
                }
                else{
                    swal({
                        title: " !!! El numero ganador fue :   "+ data.numberWin + "   Usted Perdio toda su apuesta !!!",
                        imageUrl: "img/Muerte.png",
                        showAcceptButton: true,
                        confirmButtonColor: "#e74c3c",
                        confirmButtonText: "Okey",
                        closeOnConfirm: true
                    })
                }

                cambiarBotones();
                timeApuesta=true;
                credito=found.credito;
                llenarTabla(data.arreglo);
                $('#messages').append($('<li>').text('Nueva Ronda'));

                document.getElementById("apuestaReady").disabled=true;
            }

            function llenarTabla(data){
                var perrow = 2, // 3 items per row
                count = 0, // Flag for current cellvar 
                elmnt = document.getElementById("p1");
                elmnt.remove();
                table = document.createElement("table")
                table.className="table table-bordered table-dark"
                table.id="p1";
                data.map(i=>{
                    row = table.insertRow();
                    var cell = row.insertCell();
                    cell.innerHTML = i.name;
                    
                    var cell = row.insertCell();
                    cell.innerHTML = i.credito;

                })
                
            // ATTACH TABLE TO CONTAINER
            document.getElementById("Apostadores").appendChild(table);
            }

            function apostar(x){
                console.log(usuario);
                
                swal({
                    title: "Ventana de apuestas",
                    text: 'Cuanto desea apostar:',
                    type: 'input',
                    inputType: 'number',
                    showCancelButton: true,
                    closeOnConfirm: false,
                    animation: "slide-from-top"
                    }, function(inputValue){
                        if(inputValue){
                            if(inputValue>credito){
                                alert('No se pudo por saldo insuficiente');
                            }
                            else{
                                numeroAPuesta=x;
                                switch (x) {
                                    case 37:
                                        console.log('case fila1')
                                        numeroAPuesta='Fila 1';
                                        break;
                                    case 38:
                                        numeroAPuesta='Fila 2';
                                        break;
                                    case 39:
                                        numeroAPuesta='Fila 3';
                                        break;
                                    case 40:
                                        numeroAPuesta='Color Rojo';
                                        break;
                                    case 41:
                                        numeroAPuesta='Color Negro';
                                        break;

                                }
                                swal({
                                    // hay que cambiar la x
                                    title: " ¡Usted aposto "+inputValue+" al "+numeroAPuesta+" !!!",
                                    imageUrl: "img/fichas.png",

                                    showAcceptButton: true,
                                    confirmButtonColor: "#e74c3c",
                                    confirmButtonText: "Okey",
                                    closeOnConfirm: false,
                                })
                                document.getElementById("apuestaReady").disabled=false;
                                socket.emit('apuesta',{numero:x,valor:inputValue,estado:true})
                                credito=credito-inputValue; 
                                var actualText = $("#inputArea").val();
                                var newText =  actualText +"\n"+ usuario +" aposto al " + x +" "+ inputValue 

                                socket.emit('textApuesta',usuario +" aposto "+inputValue+ " al " + numeroAPuesta +" ")
                            }
                            
                        }


                });



                
            }

            function otherSpin(res){
                console.log(res);
                theWheel.animation.stopAngle =res.stopAngle;
                theWheel.animation.spins=res.power;
                theWheel.startAnimation();
            }
            
            // Create new wheel object specifying the parameters at creation time.
            let theWheel = new Winwheel({
                'numSegments'       : 37,         // Specify number of segments.
                'outerRadius'       : 300,       // Set outer radius so wheel fits inside the background.
                'drawMode'          : 'image',   // drawMode must be set to image.
                'drawText'          : true,      // Need to set this true if want code-drawn text on image wheels.
                'textFontSize'      : 12,        // Set text options as desired.
                'textOrientation'   : 'curved',
                'textDirection'     : 'reversed',
                'textAlignment'     : 'outer',
                'textMargin'        : 5,
                'textFontFamily'    : 'monospace',
                'textStrokeStyle'   : 'black',
                'textLineWidth'     : 2,
                'textFillStyle'     : 'white',
                'segments'     :                // Define segments.
                [
                   {'text' : '0'},
                   {'text' : '32'},
                   {'text' : '15'},
                   {'text' : '19'},
                   {'text' : '4'},
                   {'text' : '21'},
                   {'text' : '2'},
                   {'text' : '25'},
                   {'text' : '17'},
                   {'text' : '34'},
                   {'text' : '6'},
                   {'text' : '27'},
                   {'text' : '13'},
                   {'text' : '36'},
                   {'text' : '11'},
                   {'text' : '30'},
                   {'text' : '8'},
                   {'text' : '23'},
                   {'text' : '10'},
                   {'text' : '5'},
                   {'text' : '24'},
                   {'text' : '16'},
                   {'text' : '33'},
                   {'text' : '1'},
                   {'text' : '20'},
                   {'text' : '14'},
                   {'text' : '31'},
                   {'text' : '9'},
                   {'text' : '22'},
                   {'text' : '18'},
                   {'text' : '29'},
                   {'text' : '7'},
                   {'text' : '28'},
                   {'text' : '12'},
                   {'text' : '35'},
                   {'text' : '3'},
                   {'text' : '26'}


                ],
                'animation' :                   // Specify the animation to use.
                {
                    'type'     : 'spinToStop',
                    'duration' : 5,     // Duration in seconds.
                    'spins'    : 8,     // Number of complete spins.
                    'callbackFinished' : numberWin,
                }
            });

            // Create new image object in memory.
            let loadedImg = new Image();

            // Create callback to execute once the image has finished loading.
            loadedImg.onload = function()
            {
                theWheel.wheelImage = loadedImg;    // Make wheelImage equal the loaded image object.
                theWheel.draw();                    // Also call draw function to render the wheel.
            };

            // Set the image source, once complete this will trigger the onLoad callback (above).
            loadedImg.src = "img/esta.png";
            // Vars used by the code in this page to do power controls.
            let wheelPower    = 0;
            let wheelSpinning = false;


            function numberWin() {
                winningSegment = theWheel.getIndicatedSegment();
                if (myTurn===true){

                    socket.emit('win',winningSegment.text)
                }
               myTurn=false;

            }
                // -------------------------------------------------------
            // Function to handle the onClick on the power buttons.
            // -------------------------------------------------------
            function powerSelected(powerLevel)
            {
                // Ensure that power can't be changed while wheel is spinning.
                if (wheelSpinning == false) {
                    // Reset all to grey incase this is not the first time the user has selected the power.
                    document.getElementById('pw1').className = "";
                    document.getElementById('pw2').className = "";
                    document.getElementById('pw3').className = "";

                    // Now light up all cells below-and-including the one selected by changing the class.
                    if (powerLevel >= 1) {
                        document.getElementById('pw1').className = "pw1";
                    }

                    if (powerLevel >= 2) {
                        document.getElementById('pw2').className = "pw2";
                    }

                    if (powerLevel >= 3) {
                        document.getElementById('pw3').className = "pw3";
                    }

                    // Set wheelPower var used when spin button is clicked.
                    wheelPower = powerLevel;

                    // Light up the spin button by changing it's source image and adding a clickable class to it.
                    document.getElementById('spin_button').src = "spin_on.png";
                    document.getElementById('spin_button').className = "clickable";
                }
            }

            // -------------------------------------------------------
            // Click handler for spin button.
            // -------------------------------------------------------
            function mySpin()
            {   
                // Ensure that spinning can't be clicked again while already running.
              if(myTurn){
                if (wheelSpinning == false) {
                    // Based on the power level selected adjust the number of spins for the wheel, the more times is has
                    // to rotate with the duration of the animation the quicker the wheel spins.
                    if (wheelPower == 1) {
                        theWheel.animation.spins = 2;
                    } else if (wheelPower == 2) {
                        theWheel.animation.spins = 5;
                    } else if (wheelPower == 3) {
                        theWheel.animation.spins = 8;
                    }

                    // Disable the spin button so can't click again while wheel is spinning.
                    document.getElementById('spin_button').src       = "spin_off.png";
                    document.getElementById('spin_button').className = "";

                    // Begin the spin animation by calling startAnimation on the wheel object.
                    let stopAt = (Math.floor((Math.random() * 360)))
                    //let stopAt = 180;
                    console.log(stopAt,theWheel.animation.spins);

                    theWheel.animation.stopAngle = stopAt;

                    theWheel.startAnimation();

                    // Set to true so that power can't be changed and spin button re-enabled during
                    // the current animation. The user will have to reset before spinning again.
                    wheelSpinning = true;
                    socket.emit('rotateHost',{power:theWheel.animation.spins,stopAngle:stopAt});
                }
                // myTurn=false;
           
              }
              else{
                  alert('Faltan jugadores por dar ready o estas solo en la sala')
             }
            }

            // -------------------------------------------------------
            // Function for reset button.
            // -------------------------------------------------------
            function resetWheel()
            {
                theWheel.stopAnimation(false);  // Stop the animation, false as param so does not call callback function.
                theWheel.rotationAngle = 0;     // Re-set the wheel angle to 0 degrees.

                document.getElementById('pw1').className = "";  // Remove all colours from the power level indicators.
                document.getElementById('pw2').className = "";
                document.getElementById('pw3').className = "";

                wheelSpinning = false;          // Reset to false to power buttons and spin can be clicked again.
            }

            // -------------------------------------------------------
            // Called when the spin animation has finished by the callback feature of the wheel because I specified callback in the parameters.
            // note the indicated segment is passed in as a parmeter as 99% of the time you will want to know this to inform the user of their prize.
            // -------------------------------------------------------
            function connectRoom(room){
                sala=room;
                usuario=document.getElementById("Name").value
                socket.emit('JoinRoom',{room:sala,name:usuario})
                joinRoom(sala);
            }         
            function joinRoom(sala){
                swal({
                        title: " ¡Bienvido a la sala "+sala+" !!!",
                        imageUrl: "img/Muerte.png",
                        showAcceptButton: true,
                        confirmButtonColor: "#e74c3c",
                        confirmButtonText: "Okey",
                        closeOnConfirm: true

                    })
                    document.getElementById('sala').innerHTML= sala;
                    
                    switch (sala){

                        case "Diamante":
                        ponerImagen("img/Diamante.png")
                        break;

                        case "Trebol":
                        ponerImagen("img/trebol.png")
                        break;

                        case "Corazon":
                        ponerImagen("img/Corazon.png")
                        break;

                        case "Pica":
                        ponerImagen("img/pica.jpg")
                        break;

                    }
                  
                }
        

            function SelectHost(){
                swal({
                        title: " Te toca girar la Rueleta",
                        imageUrl: "img/Diamante.png",

                        showAcceptButton: true,
                        confirmButtonColor: "#e74c3c",
                        confirmButtonText: "Okey",
                        closeOnConfirm: true
                    })
            
            }

            function ponerImagen(img){
                
                
                var elem = document.getElementById('imgsala');
                elem.src = img; 

            }
  
        </script>
    </body>
</html>
